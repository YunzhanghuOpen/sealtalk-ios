
  ![redpacket](http://www.easemob.com/themes/official_v2/Public/img/site-brand@2x.png "环信红包")

## 环信红包接入文档

##### 环信红包简介
环信红包是基于`环信ChatDemoUI3.0`开发的，可以让用户在做最少改动的情况下，快速集成红包功能的SDK。
**集成前，请先去官网下载最新的`环信ChatDemoUI`,用最新的`EaseUI`替换本地的`EaseUI`。**

##### SDK介绍
`RedpacketSDK`共分2个文件夹，`RedpacketLib`实现的是红包收发流程，和保障用户账号安全的安全体系。 `RedpacketOpen`实现的是红包Cell的显示，红包消息的发送。其中`RedpacketLib`是闭源的，RedpacketOpen是开源的，用户可根据需要自行修改。（目前暂不支持环信2.0UI）


#### Step1. 导入SDK
 将红包库`RedpacketSDK`添加到工程里，`RedpacketSDK`包含静态库RedpacketLib和开源库RedpacketOpen

#### Step2. 配置商户ID
**@Class:** *AppDelegate*

**@Function:** *- (BOOL)application:(UIApplication \*)application didFinishLaunchingWithOptions:(NSDictionary \*)launchOptions；*

**@description:** 进行商户ID的初始化， 商户ID为环信分配的商户Id， appKey为环信分配的appKey**

```
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
{   
    //TODO:1 配置商户的商户ID， 和商户的APPKey
    [RedPacketUserConfig configWithDealerCode:@"243801" appKey:@"easemob-demo#chatdemoui"];
    
    ...
    ...
}
    
```

#### Step3. 替换用户登录当前App的UserID（非环信登录用户ID）
**@Class:** *RedPacketUserConfig*

**@Function:** *-(NSString \*)appUserId*

**@description:** Demo里某前用的还是环信的用户ID，请替换成当前App用户的登录ID。

#### Step4. 获取用户Token
**@Class:** *AppDelegate+EaseMob*

**@Function:** *- (void)loginStateChange:(NSNotification \*)notification*

**@description:** 在*loginStateChange*方法里边调用*RedpacketUserConfig* 中获取用户名和密码的方法 (获取用户Token后，可访问相关接口)。

```

- (void)loginStateChange:(NSNotification *)notification
{
    UINavigationController *navigationController = nil;
    
    BOOL isAutoLogin = [[[EaseMob sharedInstance] chatManager] isAutoLoginEnabled];
    BOOL loginSuccess = [notification.object boolValue];
    
    if (isAutoLogin || loginSuccess) {
		
		/* ----- 开始位置 ----- */
		
    	// 1.获取登陆信息
      	NSDictionary *loginInfo = [[EaseMob sharedInstance].chatManager loginInfo];
      	
      	// 2.验证用户登陆信息
        [[RedPacketUserConfig sharedConfig] validateHxUserName:loginInfo[kSDKUsername] 		andHxUserPass:loginInfo[kSDKPassword]];
        
		/* ----- 结束位置 ----- */        
    ...
    ...
}

```

#### Step5.修改协议位置
**@class:** *ChatViewController*

```
@interface ChatViewController ()<UIAlertViewDelegate,EaseMessageViewControllerDelegate, EaseMessageViewControllerDataSource>

```

**@description:** 将`ChatViewController.m`中的协议`<EaseMessageViewControllerDelegate, EaseMessageViewControllerDataSource>`，放到`ChatViewController.h`中

#### Step6.替代聊天窗口ChatViewController
**@OriginClass:** *ChatViewController*

**@ReplaceClass:** *ChatWithRedpacketViewController*

**@description:** 替代*ChatViewController*为*ChatWithRedpacketViewController（带有红包功能的聊天窗口）* 如果你没有使用*ChatViewController*你可以让*ChatWithRedpacketViewController* 继承你的聊天窗口，但是你的聊天窗口必须继承自*EaseMessageViewController*
#### Step7.修改红包按钮事件的索引
**@Class:** *ChatWithRedPacketViewController*

**@Function:** 

*- (void)messageViewController:(EaseMessageViewController *)viewController didSelectMoreView:(EaseChatBarMoreView *)moreView AtIndex:(NSInteger)index*
```
/**
 *  红包单击事件索引
 */
static NSInteger const _redpacket_send_index   = 5;

/**
 *  零钱单击事件索引
 */
static NSInteger const _redpacket_change_index = 6;```**@description:** 不同的App，聊天界面中更多功能列表页里的功能按钮数量可能不同，对应的位置也可能不同，所以如果对应位置不正确，还需要修改上边两处的索引为正确的数值。#### Step8.用户零钱页面
**@Class:** *RedpacketViewControl*

**@Function:** *+ (UIViewController \*)changeMoneyController* 

**@description:** 零钱是存放用户充值，或者受到的红包的页面。 获取零钱页的Controller，App可以在需要的地方添加零钱页面, Demo中我们是放在设置页面中的，可以参考。#### Step9.快喊老板来发红包了


#####注意
环信红包是基于`ChatDemoUI3.0`开发的，以上介绍也是基于`ChatDemoUI3.0`，如果您的APP不依赖于环信'`ChatDemoUI3.0`'的`ChatViewController`，或者不依赖于`EaseUI`，可以参考`ChatWithRedPacketViewController`自行实现红包功能。